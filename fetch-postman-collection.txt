name: 'Fetch Postman Collection'

permissions:
  contents: write # Allow GitHub Actions to write to the repository

on:
  workflow_dispatch: # Allows manual triggering of the workflow
  push:
    branches:
      - main # Trigger the action only on pushes to the main branch

jobs:
  fetch-collection:
    runs-on: ubuntu-latest # Specifies the OS to run the job on

    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # Checks out the repository

      - name: Fetch Postman Collection
        shell: bash
        run: |
          curl -s -H "X-API-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.postman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}" \
            | jq '.collection' > postman-collection.json
          echo "saved_file=postman-collection.json" >> $GITHUB_OUTPUT

      - name: Validate JSON
        shell: bash
        run: |
          jq empty postman-collection.json || (echo "Invalid JSON file" && exit 1)

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git merge origin/main --no-edit || echo "No conflicts to resolve."
          git add .
          git commit -m "Add updated Postman collection"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
