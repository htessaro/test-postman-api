name: 'Fetch Postman Collection'

on:
  workflow_dispatch: # Allows manual triggering of the workflow
  push:
    branches:
      - main # Trigger the action only on pushes to the main branch

jobs:
  fetch-collection:
    runs-on: ubuntu-latest # Specifies the OS to run the job on

    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # Checks out the repository

      - name: Fetch Postman Collection
        shell: bash
        run: |
          curl -s -H "X-API-Key: ${{ secrets.POSTMAN_API_KEY }}" \
            "https://api.postman.com/collections/${{ secrets.POSTMAN_COLLECTION_ID }}" \
            | jq '.collection' > postman-collection.json
          echo "saved_file=postman-collection.json" >> $GITHUB_OUTPUT

      - name: Validate JSON
        shell: bash
        run: |
          jq empty postman-collection.json || (echo "Invalid JSON file" && exit 1)

      - name: Commit Postman Collection to Repo
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add postman-collection.json
          git commit -m "Add updated Postman collection"
          git push
